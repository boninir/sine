{% extends 'AppBundle::layout.html.twig' %}

{% block core %}

    <div class="container center-block" role="main">
        <div class="jumbotron">
            <h3 class="text-center">
                {{ vehicle.mark ~ ' ' ~ vehicle.type }}
                <a class="btn btn-warning" data-toggle="modal" data-target="#myModal">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                </a>
            </h3>
            {% for flash_message in app.session.flashBag.get('notice') %}
                <div class="alert alert-success alert-dismissible flash-notice" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    {{ flash_message }}
                </div>
            {% endfor %}
            <div class="row">
                <div class="col-md-7"><b>- Marque :</b> {{ vehicle.mark }}</div>
                <div class="col-md-5"><b>- Modèle :</b> {{ vehicle.model }}</div>
            </div>
            <div class="row">
                <div class="col-md-7"><b>- Immatriculation :</b> {{ vehicle.registration }}</div>
                <div class="col-md-5"><b>- Type :</b> {{ vehicle.type }}</div>
            </div>
            <div class="row">
                <div class="col-md-7"><b>- CV :</b> {{ vehicle.cv }}</div>
                <div class="col-md-5"><b>- N° châssis :</b> {{ vehicle.frame }}</div>
            </div>
            <div class="row">
                <div class="col-md-7"><b>- Couleur :</b> {{ vehicle.color }}</div>
                <div class="col-md-5"><b>- Kilomètres parcouru :</b> {{ vehicle.kilometerTraveled }}</div>
            </div>
            <div class="row">
                <div class="col-md-7"><b>- Kilomètres au compteur :</b> {{ vehicle.kilometerOnCounter }}</div>
                <div class="col-md-5"><b>- Mise en service :</b> {{ vehicle.releaseDate|date('d/m/Y') }}</div>
            </div>
            <div class="row">
                <div class="col-md-7"><b>- Bon SAP :</b> {{ vehicle.sapVoucher }}</div>
                <div class="col-md-5"><b>- Essence :</b> {{ vehicle.fuel.denomination }}</div>
            </div>
        </div>

        <div class="row text-center center-block">
            <ul class="nav nav-pills" role="tablist">
                <li class="col-md-1"></li>
                <li role="presentation" class="active col-md-2"><a href="#mecanique" role="tab" data-toggle="tab">Mécanique</a></li>
                <li role="presentation" class="col-md-2"><a href="#carosserie" role="tab" data-toggle="tab">Carrosserie</a></li>
                <li role="presentation" class="col-md-2"><a href="#interieur" role="tab" data-toggle="tab">Intérieur</a></li>
                <li role="presentation" class="col-md-2"><a href="#nettoyage" role="tab" data-toggle="tab">Nettoyage</a></li>
                <li role="presentation" class="col-md-2"><a href="#photos" role="tab" data-toggle="tab">Photos</a></li>
            </ul>
        </div>

        <hr>

        <div class="row">
            {{ form_start(formIntervention) }}
                <div class="tab-content text-center">
                    <div role="tabpanel" class="tab-pane active row" id="mecanique">
                        {% for interv in formIntervention.interventions if interv.vars.data.typeIntervention.denomination == 'Mécanique' %}
                            <div class="row" data-intervention-id="{{ interv.vars.data.id }}">
                                <br>
                                <div class="col-md-3"></div>
                                <div class="col-md-2 text-right">
                                    <p><b>{{ interv.vars.data.denomination }}</b></p>
                                </div>
                                <div class="col-md-2">
                                    {{ form_row(interv.select) }}
                                </div>

                                <div class="col-md-2">
                                    <a class="btn btn-warning set-comment" data-target="#modal-{{ interv.vars.data.id }}" {% if interv.select.vars.data is empty %}disabled="disabled"{% else %}data-toggle="modal"{% endif %}>
                                        <span class="content">Ajouter un commentaire</span>
                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                    </a>

                                    <div class="modal fade text-left comment-modal" id="modal-{{ interv.vars.data.id }}" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title">Commentaire</h4>
                                                </div>
                                                <div class="modal-body">
                                                    {% form_theme interv.comment 'AppBundle:form:fields.html.twig' %}
                                                    {{ form_row(interv.comment) }}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Retour</button>
                                                    <button type="button" class="btn btn-success" data-dismiss="modal">Confirmer</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 text-left">
                                    <div class="comment">
                                        {% if interv.comment.vars.data != null %}
                                            {{ interv.comment.vars.data }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div role="tabpanel" class="tab-pane row" id="carosserie">
                        {% for interv in formIntervention.interventions if interv.vars.data.typeIntervention.denomination == 'Carrosserie' %}
                            {% if loop.index is even %}
                                <div class="row">
                            {% endif %}
                            <div class="row text-center col-md-5" data-intervention-id="{{ interv.vars.data.id }}">
                                <br>
                                <div><b>{{ interv.vars.data.denomination }}</b></div>
                                <br>
                                {% if interv.vars.data.answers is empty %}
                                    <div>
                                        {{ form_row(interv.select) }}
                                    </div>
                                {% else %}
                                    <div class="choices">
                                        {% for select in interv.select %}
                                            <span class="text-nowrap">{{ form_widget(select) }} {{ form_label(select) }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <br>
                                <div>
                                    <a class="btn btn-warning set-comment" data-target="#modal-{{ interv.vars.data.id }}" {% if interv.select.vars.data is empty %}disabled="disabled"{% else %}data-toggle="modal"{% endif %}>
                                        <span class="content">Ajouter un commentaire</span>
                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                    </a>

                                    <div class="modal fade text-left comment-modal" id="modal-{{ interv.vars.data.id }}" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title">Commentaire</h4>
                                                </div>
                                                <div class="modal-body">
                                                    {% form_theme interv.comment 'AppBundle:form:fields.html.twig' %}
                                                    {{ form_row(interv.comment) }}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Retour</button>
                                                    <button type="button" class="btn btn-success" data-dismiss="modal">Confirmer</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment">
                                    {% if interv.comment.vars.data != null %}
                                        {{ interv.comment.vars.data }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if loop.index is odd %}
                                <div class="col-md-2"></div>
                            {% else %}
                                </div><hr>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div role="tabpanel" class="tab-pane row" id="interieur">
                        {% for interv in formIntervention.interventions if interv.vars.data.typeIntervention.denomination == 'Intérieur' %}
                            {% if loop.index is even %}
                                <div class="row">
                            {% endif %}
                            <div class="row text-center col-md-5" data-intervention-id="{{ interv.vars.data.id }}">
                                <br>
                                <div><b>{{ interv.vars.data.denomination }}</b></div>
                                <br>
                                {% if interv.vars.data.answers is empty %}
                                    <div>
                                        {{ form_row(interv.select) }}
                                    </div>
                                {% else %}
                                    <div class="choices">
                                        {% for select in interv.select %}
                                            <span class="text-nowrap">{{ form_widget(select) }} {{ form_label(select) }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <br>
                                <div>
                                    <a class="btn btn-warning set-comment" data-target="#modal-{{ interv.vars.data.id }}" {% if interv.select.vars.data is empty %}disabled="disabled"{% else %}data-toggle="modal"{% endif %}>
                                        <span class="content">Ajouter un commentaire</span>
                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                    </a>

                                    <div class="modal fade text-left comment-modal" id="modal-{{ interv.vars.data.id }}" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title">Commentaire</h4>
                                                </div>
                                                <div class="modal-body">
                                                    {% form_theme interv.comment 'AppBundle:form:fields.html.twig' %}
                                                    {{ form_row(interv.comment) }}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Retour</button>
                                                    <button type="button" class="btn btn-success" data-dismiss="modal">Confirmer</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment">
                                    {% if interv.comment.vars.data != null %}
                                        {{ interv.comment.vars.data }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if loop.index is odd %}
                                <div class="col-md-2"></div>
                            {% else %}
                                </div><hr>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div role="tabpanel" class="tab-pane row" id="nettoyage">
                        {% for interv in formIntervention.interventions if interv.vars.data.typeIntervention.denomination == 'Nettoyage' %}
                            <div class="row" data-intervention-id="{{ interv.vars.data.id }}">
                                <br>
                                <div class="col-md-3"></div>
                                <div class="col-md-2 text-right">
                                    <p><b>{{ interv.vars.data.denomination }}</b></p>
                                </div>
                                <div class="col-md-2">
                                    {{ form_row(interv.select) }}
                                </div>

                                <div class="col-md-2">
                                    <a class="btn btn-warning set-comment" data-target="#modal-{{ interv.vars.data.id }}" {% if interv.select.vars.data is empty %}disabled="disabled"{% else %}data-toggle="modal"{% endif %}>
                                        <span class="content">Ajouter un commentaire</span>
                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                    </a>

                                    <div class="modal fade text-left comment-modal" id="modal-{{ interv.vars.data.id }}" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title">Commentaire</h4>
                                                </div>
                                                <div class="modal-body">
                                                    {% form_theme interv.comment 'AppBundle:form:fields.html.twig' %}
                                                    {{ form_row(interv.comment) }}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Retour</button>
                                                    <button type="button" class="btn btn-success" data-dismiss="modal">Confirmer</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 text-left">
                                    <div class="comment">
                                        {% if interv.comment.vars.data != null %}
                                            {{ interv.comment.vars.data }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div role="tabpanel" class="tab-pane row" id="photos">
                        <div class="collection-form">
                            {{ form_row(formIntervention.pictures) }}
                        </div>

                        {% if pictures|length != 0 %}
                            <hr>
                            <div class="text-left">
                                <h3>Liste des photos :</h3>

                                {% for picture in pictures %}
                                    <div class="text-center col-md-3">
                                        <img src="{{ asset('vehicle-pictures/' ~ vehicle.id ~ '/' ~ picture.name) }}" width="100%">
                                        <a href="{{ path('delete-picture', {id: picture.id}) }}" class="btn btn-danger">Supprimer</a>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <br>
                    <input type="submit" value="Enregistrer le contrôle" class="btn btn-success" />

                    {{ form_widget(formIntervention) }}
                </div>
            {{ form_end(formIntervention) }}
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        {% form_theme form 'AppBundle:form:fields.html.twig' %}
        {{ form_start(form, {'attr': {'class': ''} }) }}
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">{{ vehicle.mark ~ ' ' ~ vehicle.type }}</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_widget(form) }}
                    </div>
                    <div class="modal-footer">
                        <input type="submit" value="Mettre à jour le véhicule" class="btn btn-success" />
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Retour</button>
                    </div>
                </div>
            </div>
        {{ form_end(form) }}
    </div>


{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $('#myTabs a').click(function (e) {
            e.preventDefault()
            $(this).tab('show')
        });

        $('#myModal').on('shown.bs.modal', function () {
            $('#myInput').focus()
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            // On récupère la balise <div> en question qui contient l'attribut « data-prototype » qui nous intéresse.
            var $containers = $('div[data-prototype]');

            $containers.each(function() {
                // On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement
                var $container = $(this),
                    index = $container.find(':input').length;

                // On ajoute un premier champ automatiquement s'il n'en existe pas déjà un (cas d'une nouvelle annonce par exemple).
                if (index == 0) {
                    addCategory($container);
                } else {
                    // Pour chaque catégorie déjà existante, on ajoute un lien de suppression
                    $container.children('div').each(function() {
                        addDeleteLink($(this));
                    });
                }

                var $addLink = $('<a href="#" id="' + $(this).data('add-id') + '" class="btn btn-warning">' +
                    $(this).data('add-label') +
                    ' <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"/>' +
                    '</a>');

                $container.parent().append($addLink);

                // On ajoute un nouveau champ à chaque clic sur le lien d'ajout.
                $addLink.click(function(e) {
                    addCategory($container);
                    e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                    return false;
                });
            });

            // La fonction qui ajoute un formulaire Categorie
            function addCategory($container) {
                var index = $container.find(':input').length;
                // Dans le contenu de l'attribut « data-prototype », on remplace :
                // - le texte "__name__label__" qu'il contient par le label du champ
                // - le texte "__name__" qu'il contient par le numéro du champ
                var $prototype = $($container.data('prototype').replace(/__name__label__/g, $container.data('data-label') + (index+1))
                        .replace(/__name__/g, index));
                $prototype
                    .addClass('text-left row')
                    .find('input').addClass('col-md-6')
                ;

                // On ajoute au prototype un lien pour pouvoir supprimer la catégorie
                addDeleteLink($prototype);

                // On ajoute le prototype modifié à la fin de la balise <div>
                $container.append($prototype);
            }

            // La fonction qui ajoute un lien de suppression d'une catégorie
            function addDeleteLink($prototype) {
                // Création du lien
                $deleteLink = $('<a href="#" class="btn btn-danger">Supprimer</a>');

                // Ajout du lien
                $prototype.append($deleteLink);

                // Ajout du listener sur le clic du lien
                $deleteLink.click(function(e) {
                    $prototype.remove();
                    e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                    return false;
                });
            }
        });
    </script>


    <script type="text/javascript">
        $(document).ready(function() {
            $('.choose-intervention').change(function(e) {
                var row = $(this).closest('.row'),
                    comment = $(row).find('textarea').val()
                ;

                if ($(this).is(':checked')) {
                    $(row).find('.comment').html(comment);
                    $(row).find('.set-comment').attr('disabled', false);
                    $(row).find('.set-comment').attr('data-toggle', 'modal');
                } else {
                    $(row).find('.comment').html('');
                    $(row).find('.set-comment').attr('disabled', true);
                    $(row).find('.set-comment').removeAttr('data-toggle');
                }
            });

            $('.choices :checkbox').change(function() {
                var row = $(this).closest('.row'),
                    choices = $(row).find(':checkbox'),
                    comment = $(row).find('textarea').val(),
                    commentEnable = false
                ;

                $(choices).each(function() {
                    if ($(this).is(':checked')) {
                        commentEnable = true;

                        return;
                    }
                });

                if (commentEnable) {
                    $(row).find('.comment').html(comment);
                    $(row).find('.set-comment').attr('disabled', false);
                    $(row).find('.set-comment').attr('data-toggle', 'modal');
                } else {
                    $(row).find('.comment').html('');
                    $(row).find('.set-comment').attr('disabled', true);
                    $(row).find('.set-comment').removeAttr('data-toggle');
                }
            });

            $('.comment-modal button').click(function() {
                var row = $(this).closest('.row'),
                    comment = $(row).find('textarea').val()
                ;

                $(row).find('.comment').html(comment);

                if (comment != '') {
                    $(row).find('.set-comment .content').html('Modifier le commentaire');
                } else {
                    $(row).find('.set-comment .content').html('Ajouter un commentaire');
                }
            });
        });
    </script>
{% endblock %}